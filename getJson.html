<!doctype html>
<html lang="en">

<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="/css/hackers.css" rel="stylesheet" media="screen">
<script src="/js/jquery-3.6.0.js" type="text/javascript"></script>
<!-- header('Content-Type: application/json; charset=utf-8'); -->

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
    <script>
        $(document).ready(function () {
            $pload = new Date();
            $checkSaved = new Date();
            $lastSaved = new Date();
            $lastLoad = new Date();
            // correcting difference between javascript time locale between Mac and Windows
            //            var d = new Date();
            $2day = $pload.toJSON().substr(0, 10).replaceAll("-", "");
            console.log("today: " + $2day);
            $pload = $pload.toTimeString().substr(0, 8);
            $("#time").html("page loaded: " + $pload);
            $jsonFile = $2day + "results.json";
            reloadJSON();
            $("#load").html("<br/>lastSaved (main):" + $lastSaved);
            var myVar = setInterval(function () { myTimer('bucht'); }, 5000);
            var myTim = setInterval(myTime, 1000);
        });
        function reloadJSON() {
            $.getJSON($jsonFile, function (data) {
                var items = [];
                data.reverse();
                $.each(data, function (i, item) {
                    if (i == 0) $('#currentTrack').html(item.par + " " + item.title + " - " + item.artist + "<br/>" + item.time);
                    if (i >= 1) {
                        items.push("<li id='" + i + "'>" + item.otitle + "</li>");
                        items.push("<dl class='dl-horizontal'><dt>Title</dt><dd>" + item.title + "</dd>");
                        items.push("<dt>Artis</dt><dd>" + item.artist + "</dd></dl>");
                    }
                    if (i == 10) return false;
                });
                $("<ul/>", {
                    "class": "my-new-list",
                    html: items.join("")
                }).appendTo("#content");

            });
            $lastSaved = getLastSaved();
            console.log($lastSaved);
        }
        function getLastSaved() {
            var xhr = $.ajax({
                url: $jsonFile,
                success: function (response) {
                    $checkSaved = new Date(xhr.getResponseHeader("Last-Modified")).toTimeString().substr(0, 8);
                    $("#saved").html("<br/>saved (from getLastSaved): " + $checkSaved);
                }
            });
            //console.log($lastSaved);
            return $checkSaved;
        }
        function myTimer(str) {
            $pload = new Date();
            $pload = $pload.toTimeString().substr(0, 8);
            //$lastSaved = $lastSaved.toTimeString().substr(0,8);
            $("#time").html("check refresh: " + $pload + "(" + str + ")" +
                "<br/>lastSaved (myTimer): " + $lastSaved +
                "<br/>saved (getLastSaved): " + getLastSaved() +
                "<br/>saved (checkSaved): " + $checkSaved);
            //console.log("fromTimer:" + $lastSaved +"<br/>checkSaved"+$checkSaved);
            if ($lastSaved != $checkSaved) {
                $("#content").html("");
                reloadJSON();
                $("#time").append("<b>Reloaded</b>");
                $("#load").html("<br/>lastLoad: " + $lastLoad + " and saved:" + getLastSaved());
            }
        }
        function myTime() {
            $time = new Date();
            $("#timeSpan").html($time.toTimeString().substr(0, 8));
        }
    </script>

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">

                <a class="brand" href="#">PBBbyPsyl0</a>

                <!--/.nav-collapse -->
            </div>
        </div>
    </div>
    <div class="container">
        <!-- Main hero unit for a primary marketing message or call to action -->
        <div class="row">
            <div class="jumbotron jumbotron-fluid  col-sm-7">
                <h2>Welcome to PBB-by-Psyl0</h2>
                <p>
                    This is an history log of what is playing on PBB Radio. This site is currently under construction...
                    I'm currently implementing a way to search by time and also display statistics.<br />
                    I started this project by the end of April 2021... </p>
                <h2>Player: <span id="timeSpan" style="font-size:x-large; font-weight: bolder;background-color: black;"
                        class=""></span></h2><audio controls="" autoplay="false" name="media"
                    style="height:30px; width:250px;">
                    <source src="https://pbbradio.com:8443/128" type="audio/aac">
                </audio>
                <div id="currentTrack" class="jumbotron-fluid">current</div>
                <!-- <p><a href="#" class="btn btn-primary btn-large">Learn more »</a></p> -->
            </div>
            <div id="todoList" class="jumbotron jumbotron-fluid col-sm-3">
                <br />
                <h3>Todo:</h3>
                <ul>
                    <li>Inject json into Database</li>
                    <li>get data from DB</li>
                    <li>search from DB</li>
                    <li>enhance genre tagging</li>
                    <li>Mobile responsive</li>
                </ul>
            </div>
        </div>
        <!-- Example row of columns -->

        <div class="row">
            <div class="span8">
                <h2>Latest track played:</h2>
                <p>
                <div id="content"></div>
                </p>
                <!-- <p><a class="btn" href="#">View details »</a></p> -->
            </div>
        </div>
        <div class="row">
            <div class="span3">
                <h4>Debug output</h4>
                <p>
                <div id="time"> </div>
                <div id="load"> </div>
                <div id="saved"> </div>
                </p>
                <!-- <p><a class="btn" href="#">View details »</a></p> -->
            </div>
        </div>
        <hr>

        <footer>
            <p>© PBBbyPsyl0 2021</p>
        </footer>

    </div>
    <hr />
    <!-- Le javascript  ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/bootstrap/js/bootstrap.min.js"></script>

</body>

</html>